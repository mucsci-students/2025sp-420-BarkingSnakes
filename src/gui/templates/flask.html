<!DOCTYPE html>
<html>
<link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêç</text></svg>">

<head>
    <title>BS-UML</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<head>
    <script src="https://cdn.jsdelivr.net/npm/leader-line"></script>
</head>

<body style="background-color: #0e1113;">
    <div id="toolbar">
        <div id="addButtons">
            <button onclick="showAddClassModal()">Add Class</button>
            <button onclick="showAddRelationModal()">Add Relationship</button>
            <button onclick="showEditClassModal()">Edit Class</button> <!-- New button -->

        </div>
        <div id="otherButtons">
            <button onclick="showRecenterModal()">Re-center Class</button>
            <button onclick="showNewModal()">New</button>
            <button onclick="showSaveModal()">Save</button>
            <button onclick="showLoadModal()">Load</button>
            <button onclick="showExportModal()">Export HTML</button>
        </div>
        <button id="quitButton" onclick="confirmQuit()">Quit</button>
    </div>

    <div id="zoomControls" style="margin-left: auto; margin-right: 10px;">
        <label for="zoomSlider" style="color: white;">Zoom:</label>
        <input id="zoomSlider" type="range" min="25" max="200" value="100" step="10" oninput="adjustZoom(this.value)"
            style="width: 150px;">
    </div>


    <div id="editClassModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditClassModal()">&times;</span>
            <h2>Edit Class</h2>
            <p>Select a class to edit:</p>
            <select id="editClassDropdown"></select>
            <button onclick="openEditClassDetails()">Submit</button>
        </div>
    </div>

    <div id="editClassDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>Edit Class Details</h2>

            <!-- Editable Class Name -->
            <h3>Class Name</h3>
            <input type="text" id="editableClassName" class="editable-class-name" placeholder="Class Name" />

            <h3>Relationships</h3>
            <div id="existingRelationshipsList"></div>

            <!-- Existing Fields -->
            <h3>Fields</h3>
            <div id="existingFieldsList"></div>

            <!-- Add New Field -->
            <h3>Add Field</h3>
            <input type="text" id="newFieldName" placeholder="Field Name" />
            <input type="text" id="newFieldType" placeholder="Field Type" />
            <button onclick="addFieldToClass()">Add Field</button>

            <hr />

            <!-- Existing Methods -->
            <h3>Methods</h3>
            <div id="existingMethodsList"></div>

            <!-- Add New Method -->
            <h3>Add Method</h3>
            <input type="text" id="newMethodName" placeholder="Method Name" />
            <input type="text" id="newMethodReturnType" placeholder="Return Type" />
            <input type="text" id="newMethodParams" placeholder="Parameters (comma-separated)" />
            <button onclick="addMethodToClass()">Add Method</button>
        </div>
    </div>




    <div id="diagramContainer" style="overflow: auto; width: 100%; height: calc(100vh - 60px);">
        <div id="content" style="transform-origin: 0 0; transform: scale(1);">
            <!-- Diagram content goes here -->
        </div>
    </div>
    <div id="ClassTable" style="display: none;">
        <!-- <table id="Data">
        </table> -->
    </div>

    <div id="RelationTable" style="display: none;">
        <!-- <table id="RelationData"> -->
        <!-- Relation data will be inserted here -->
        <!-- </table> -->
    </div>

    <div id="ClassDetails" style="display: none;">
        <button class="close" onclick="closeClassDetails()">&times;</button>
        <!-- Class details will be displayed here -->
    </div>

    <!-- The Modal for creating a new project -->
    <div id="newModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewModal()">&times;</span>
            <h2>New File</h2>
            <p>Enter File Name:</p>
            <input type="text" id="newFileNameInput" />
            <button onclick="newProject(false)">Create Project</button>
        </div>
    </div>

    <!-- The Modal for saving the project -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSaveModal()">&times;</span>
            <h2>Save File</h2>
            <p>Enter File Name:</p>
            <input type="text" id="saveFileNameInput" />
            <button onclick="saveProject(false)">Save</button>
        </div>
    </div>
    <!-- Modal for load -->
    <div id="loadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoadModal()">&times;</span>
            <h2>Load File</h2>
            <p>Enter File Name:</p>
            <input type="text" id="loadFileNameInput" />
            <button onclick="loadProject(false)">Load</button>
            <p id="loadError" style="color: red; display: none;">Incorrect file name/type</p>
        </div>
    </div>
    <!-- Modal for exporting -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeExportModal()">&times;</span>
            <h2>Export File</h2>
            <p>Enter File Name:</p>
            <input type="text" id="exportFileNameInput" />
            <button onclick="exportHTML()">Export</button>
            <p id="exportError" style="color: red; display: none;">Incorrect file name/type</p>
        </div>
    </div>

    <!-- Modal for asking the user if they want to override an existing file. -->
    <div id="yesNoModal" class="modal">
        <div class="modal-content">
            <p id="yesNoModalPrompt"></p>
            <div>
                <span><button id="btnModalYes" onclick="">Yes</button></span>
                <span><button id="btnModalNo" onclick="toggleVisibility(['yesNoModal'])">No</button></span>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div id="addClassModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddClassModal()">&times;</span>
            <h2>Add Class</h2>
            <p>Enter Class Name:</p>
            <input type="text" id="addClassInput" />
            <button onclick="addClassFromModal()">Add Class</button>
        </div>
    </div>

    <!-- Add Relationship Modal -->
    <div id="addRelationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddRelationModal()">&times;</span>
            <h2>Add Relationship</h2>
            <p>Select Relationship Type:</p>
            <select id="relationTypeDropdown">
                <option value="Inheritance">Inheritance</option>
                <option value="Aggregation">Aggregation</option>
                <option value="Composition">Composition</option>
                <option value="Realization">Realization</option>
            </select>
            <p>Select Source Class:</p>
            <select id="relationSourceDropdown"></select>
            <p>Select Destination Class:</p>
            <select id="relationDestinationDropdown"></select>
            <button onclick="addRelationFromModal()">Add Relationship</button>
        </div>
    </div>

    <div id="recenterModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>Re-center View</h2>
            <p>Select a class to center the viewport on:</p>
            <select id="recenterClassDropdown"></select>
            <button onclick="recenterToSelectedClass()">Re-center</button>
        </div>
    </div>

    <div id="snackbar">Some text some message..</div>
    <style>
        .editable-field,
        .editable-method {
            background: #1c1c1c;
            color: white;
            border: 1px solid #04AA6D;
            border-radius: 4px;
            padding: 4px 8px;
            margin-bottom: 4px;
            font-size: 1em;
        }

        .editable-class-name {
            background-color: #222;
            border: 2px solid #04AA6D;
            border-radius: 6px;
            color: #fff;
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px;
            width: 50%;
            margin-bottom: 15px;
            box-shadow: 0 0 5px rgba(4, 170, 109, 0.8);
        }


        .class-name-header {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0.5em 0;
            color: #ffffff;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        body {
            overflow: hidden;
            background-color: #0e1113;
            padding-top: 40px;
        }

        #zoomControls {
            position: absolute;
            top: 70px;
            right: 35px;
            z-index: 3;
            background-color: #333;
            padding: 6px 12px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }


        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            z-index: 2;
        }

        #addButtons {
            display: flex;
            gap: 10px;
            margin-right: auto;
        }

        #otherButtons {
            display: flex;
            gap: 10px;
            margin: 0 auto;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        #toolbar button {
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }

        #toolbar button:hover {
            background-color: #028a5e;
        }

        #quitButton {
            position: absolute;
            right: 35px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }

        #quitButton:hover {
            background-color: #028a5e;
        }


        #ClassList {
            top: 20px;
            background-color: #04AA6D;
        }

        #RelationList {
            top: 80px;
            background-color: #04AA6D;
        }

        #ClassTable,
        #RelationTable {
            padding: 15px;
            background-color: #04AA6D;
            color: white;
            margin-bottom: 20px;
            position: fixed;
            left: 0;
            width: 20%;
        }

        #ClassTable {
            top: 0px;
            /* Position below the toolbar */
            position: relative;
            /* Allow it to expand dynamically */
        }

        #RelationTable {
            margin-top: 20px;
            /* Add spacing between ClassList and RelationList */
            position: relative;
            /* Ensure it moves down as ClassList expands */
        }

        .RelationData {
            width: 100%;
            text-align: center;
        }

        .draggable-bar {
            width: 100%;
            height: 18px;
            background-color: #04AA6D;
            cursor: move;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        #ClassDetails {
            position: absolute;
            /* Changed from fixed to absolute */
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px;
            background-color: #333;
            color: white;
            border-radius: 10px;
            width: 20%;
            text-align: center;
            display: none;
        }

        .ClassDetails {
            position: absolute;
            top: 100px;
            /* fallback value */
            left: 100px;
            padding: 10px;
            background-color: #333;
            color: white;
            border-radius: 10px;
            width: 250px;
            box-sizing: border-box;
            text-align: center;
            display: none;
            font-size: 0.9em;
        }

        .class-button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px;
            text-align: left;
            width: 100%;
            cursor: pointer;
        }

        .class-button:hover {
            background-color: #555;
        }

        .input-container {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: green;
            font-size: 18px;
        }


        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #333;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            color: white;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content input[type="text"] {
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            width: auto;
            min-width: 150px;
            max-width: 50%;
            box-sizing: border-box;
            resize: horizontal;
        }

        .modal-content input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .modal-content input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(4, 170, 109, 0.8);
        }

        .modal-content select {
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            width: auto;
            min-width: 150px;
            max-width: 50%;
            box-sizing: border-box;
            cursor: pointer;
        }

        .modal-content select:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(4, 170, 109, 0.8);
        }

        .modal-content button {
            background-color: #101010;
            /* Dark gray */
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 10px;
        }

        .modal-content button:hover {
            background-color: #000000;
            transform: scale(1.05);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        .input-mode-view {
            margin-top: 10px;
            background: transparent;
            color: white;
            border: none;
        }

        .edit-button {
            position: absolute;
            top: 20px;
            left: 10px;
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.2s;
        }

        .edit-button:hover {
            background-color: #028a5e;
            transform: scale(1.1);
        }

        .hidden {
            display: none;
        }

        #cntrAddClass>input {
            background: #333;
            width: 100%
        }

        #loadError {
            color: red;
            display: none;
            margin-top: 10px;
        }

        .delete-icon {
            color: red;
            font-size: 18px;
            transition: all 0.2s ease-in-out;
        }

        .delete-icon:hover {
            text-shadow: 0 2px 10px rgba(255, 0, 0, 0.7);
            transform: scale(1.1);
            cursor: pointer;
        }


        /* START SNACKBAR https://www.w3schools.com/howto/howto_js_snackbar.asp */
        /* The snackbar - position it at the bottom and in the middle of the screen */
        #snackbar {
            visibility: hidden;
            /* Hidden by default. Visible on click */
            min-width: 250px;
            /* Set a default minimum width */
            margin-left: -125px;
            /* Divide value of min-width by 2 */
            background-color: #f70909;
            /* Black background color */
            color: #fff;
            /* White text color */
            text-align: center;
            /* Centered text */
            border-radius: 2px;
            /* Rounded borders */
            padding: 16px;
            /* Padding */
            position: fixed;
            /* Sit on top of the screen */
            z-index: 1;
            /* Add a z-index if needed */
            left: 50%;
            /* Center the snackbar */
            bottom: 30px;
            /* 30px from the bottom */
        }

        /* Show the snackbar when clicking on a button (class added with JavaScript) */
        #snackbar.show {
            visibility: visible;
            /* Show the snackbar */
            /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
        However, delay the fade out process for 2.5 seconds */
            -webkit-animation: fadein 0.5s, fadeout 0.5s 4.5s;
            animation: fadein 0.5s, fadeout 0.5s 4.5s;
        }

        .delete-icon {
            color: red;
            font-size: 18px;
            transition: all 0.2s ease-in-out;
        }

        .delete-icon:hover {
            text-shadow: 0 2px 10px rgba(255, 0, 0, 0.7);
            transform: scale(1.1);
            cursor: pointer;
        }

        .add-button {
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .add-button:hover {
            background-color: #028a5e;
            transform: scale(1.05);
        }

        #diagramContainer {
            overflow: auto;
            width: 100%;
            height: calc(100vh - 60px);
        }

        #content {
            width: 2000px;
            height: 2000px;
            transform-origin: 0 0;
            position: relative;
            /* Ensure child elements are positioned correctly */
            overflow: visible;
        }

        /* Animations to fade the snackbar in and out */
        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* END SNACKBAR https://www.w3schools.com/howto/howto_js_snackbar.asp */

        input.class-name {
            background: #333;
            color: white;
            width: 100%;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            border: none;
            transition: all 0.3s ease;
        }

        input.class-name.editable {
            background: #444;
            border: 2px solid #04AA6D;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(4, 170, 109, 0.8);
        }
    </style>

    <script>
        function snackbar(text) {
            // Get the snackbar DIV
            var x = document.getElementById("snackbar");

            // Add the "show" class to DIV
            x.className = "show";
            x.innerText = text;

            // After 3 seconds, remove the show class from DIV
            setTimeout(function () { x.className = x.className.replace("show", ""); }, 5000);
        }


        /**
         * Added a "Lists" button to toggle the visibility of the class and relation lists.
         */
        function toggleLists() {
            let classTable = document.getElementById("ClassTable");
            let relationTable = document.getElementById("RelationTable");

            if (classTable.style.display === "none" || classTable.style.display === "") {
                classTable.style.display = "block";
                relationTable.style.display = "block";
                getClassList();
                getRelationList();
            } else {
                classTable.style.display = "none";
                relationTable.style.display = "none";
            }
        }

        /**
         * Fetches and displays the class list.
         * Sends a request to the server to get the list of classes.
         */
        function getClassList() {
            fetch('/classlist')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("ClassTable").innerHTML = data.html;
                    const classButtons = document.querySelectorAll("#ClassTable .class-button");
                    classButtons.forEach(button => {
                        const className = button.textContent.trim();
                        displayClassDetails(className);
                    });
                });
        }

        /**
         * Displays the classes upon startup
         */
        document.addEventListener("DOMContentLoaded", () => {
            getClassList();
        });

        function toggleVisibility(ids) {
            console.log("Toggle: " + ids);
            ids.forEach(id => {
                const elem = document.getElementById(id);
                if (!elem) {
                    console.error(`Element with ID '${id}' not found.`);
                    return;
                }
                const input = elem.getElementsByTagName("input")[0];
                console.log(elem.style.display, elem);
                if (elem.style.display === "none" || elem.style.display === "" || elem.style.display === null) {
                    elem.style.display = "block";
                    if (input) input.focus();
                } else {
                    elem.style.display = "none";
                }
            });
        }

        /**
         * Fetches and displays the relation list.
         * Sends a request to the server to get the list of relations.
         */
        function getRelationList() {
            fetch("/relationList")
                .then(res => res.json())
                .then(data => {
                    document.getElementById("RelationTable").innerHTML = data.html;
                    drawRelationshipLines();
                })
                .catch(error => console.error("Error fetching relation list:", error));
        }


        // Get the modal
        var modal = document.getElementById("myModal");
        var saveModal = document.getElementById("saveModal");
        var newModal = document.getElementById("newModal");
        var addClassModal = document.getElementById("addClassModal");
        var addRelationModal = document.getElementById("addRelationModal");
        var recenterModal = document.getElementById("recenterModal");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        var fileName;

        /**
         * Shows the modal for adding a class, relation, field, or method.
         * @param {string} type - The type of item to add.
         */
        function showModal(type) {
            if (type === 'class') {
                document.getElementById("modalPrompt").innerText = "Enter Class Name:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addClass;
            } else if (type === 'relation') {
                document.getElementById("modalPrompt").innerText = "Enter Source Class and Target Class:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addRelation;
            } else if (type === 'field') {
                document.getElementById("modalPrompt").innerText = "Enter Field Name:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addField;
            } else if (type === 'method') {
                document.getElementById("modalPrompt").innerText = "Enter Method Name:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addMethod;
            }
            modal.style.display = "block";
        }

        /**
         * Shows the new project modal.
         */
        function showNewModal() {
            closeAllModals();
            newModal.style.display = "block";
        }

        /**
         * Closes the new project modal.
         */
        function closeNewModal() {
            newModal.style.display = "none";
        }

        /**
         * Shows the save modal.
         */
        function showSaveModal() {
            closeAllModals();
            document.getElementById("saveModal").style.display = "block";
        }

        /**
         * Closes the save modal.
         */
        function closeSaveModal() {
            saveModal.style.display = "none";
        }

        /**
         * Closes the class details.
         */
        function closeClassDetails(className) {
            let detailsDiv = document.getElementById(`ClassDetails-${className}`);
            if (detailsDiv) {
                detailsDiv.style.display = "none";
                console.log(`ClassDetails-${className} closed.`); // Debug log
            } else {
                console.log(`ClassDetails-${className} not found.`); // Debug log
            }

            // Remove lines associated with the closed class, including self-relations
            const remainingLines = [];
            lines.forEach(line => {
                const isStartClass = line.start && line.start.id === `ClassDetails-${className}`;
                const isEndClass = line.end && line.end.id === `ClassDetails-${className}`;
                const isSelfRelation = isStartClass && isEndClass;

                if (isStartClass || isEndClass || isSelfRelation) {
                    console.log(`Removing line connected to ClassDetails-${className}`); // Debug log
                    line.remove(); // Remove the line from the DOM
                } else {
                    remainingLines.push(line);
                }
            });

            lines = remainingLines;
            console.log("Remaining lines:", lines);

            // Force redraw of relationship lines to ensure self-relations are removed
            drawRelationshipLines();

            // Remove the class from the DOM
            if (detailsDiv) {
                detailsDiv.remove();
            }
            updateContentSize();
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
            closeSaveModal();
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            const editClassModal = document.getElementById("editClassModal");
            if (event.target === editClassModal) {
                closeEditClassModal();
            }
            if (event.target == modal) {
                modal.style.display = "none";
            }
            if (event.target == saveModal) {
                saveModal.style.display = "none";
            }
            if (event.target == loadModal) {
                loadModal.style.display = "none";
            }
            if (event.target == newModal) {
                newModal.style.display = "none";
            }
            if (event.target == addClassModal) {
                closeAddClassModal();
            }
            if (event.target == addRelationModal) {
                closeAddRelationModal();
            }
            if (event.target === editClassDetailsModal) {
                closeEditClassDetailsModal();
            }
        }

        function closeAllModals() {
            const modals = document.querySelectorAll(".modal");
            modals.forEach(modal => {
                modal.style.display = "none";
            });
        }

        // Close Edit Class Modal
        function closeEditClassModal() {
            document.getElementById("editClassModal").style.display = "none";
        }

        // Close Edit Class Details Modal
        function closeEditClassDetailsModal() {
            document.getElementById("editClassDetailsModal").style.display = "none";
        }

        // Show Add Class Modal
        function showAddClassModal() {
            closeAllModals();
            const addClassInput = document.getElementById("addClassInput");
            if (addClassInput) {
                addClassInput.value = "";
            }
            document.getElementById("addClassModal").style.display = "block";
        }

        // Close Add Class Modal
        function closeAddClassModal() {
            document.getElementById("addClassModal").style.display = "none";
        }

        // Add Class from Modal
        function addClassFromModal() {
            const className = document.getElementById("addClassInput").value;
            if (!className) {
                snackbar("Class name cannot be empty.");
                return;
            }

            fetch("/addClass", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ classname: className })
            })
                .then(response => {
                    if (response.ok) {
                        // Get the center of the visible viewport
                        const container = document.getElementById("diagramContainer");
                        const content = document.getElementById("content");

                        const scaleMatch = content.style.transform.match(/scale\(([^)]+)\)/);
                        const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;

                        const visibleCenterX = (container.scrollLeft + container.clientWidth / 2) / scale;
                        const visibleCenterY = (container.scrollTop + container.clientHeight / 2) / scale;

                        // Update the class position in the backend
                        fetch("/updateClassPosition", {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                classname: className,
                                x_pos: visibleCenterX,
                                y_pos: visibleCenterY
                            })
                        })
                            .then(() => {
                                getClassList(); // Refresh the class list
                                closeAddClassModal();
                            });
                    } else {
                        return response.json();
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.error("Error adding class:", error));
        }

        function deleteClass(classname, override) {
            fetch("/deleteclass", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    classname: classname,
                    override: override
                })
            })
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        getClassList();
                        getRelationList();
                    }

                })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => deleteClass(classname, true);
                        no_callback = () => {
                        };

                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    }
                    else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.log(error))
        }


        // Show Add Relationship Modal
        function showAddRelationModal() {
            closeAllModals(); // Close any open modals
            document.getElementById("addRelationModal").style.display = "block";

            // Populate dropdowns with class names
            fetch("/classlist")
                .then(response => response.json())
                .then(data => {
                    const classNames = data.html.match(/<button.*?>(.*?)<\/button>/g).map(btn => btn.replace(/<.*?>/g, ''));
                    const sourceDropdown = document.getElementById("relationSourceDropdown");
                    const destinationDropdown = document.getElementById("relationDestinationDropdown");

                    sourceDropdown.innerHTML = "";
                    destinationDropdown.innerHTML = "";

                    classNames.forEach(className => {
                        const option = `<option value="${className}">${className}</option>`;
                        sourceDropdown.innerHTML += option;
                        destinationDropdown.innerHTML += option;
                    });
                });
        }

        // Close Add Relationship Modal
        function closeAddRelationModal() {
            document.getElementById("addRelationModal").style.display = "none";
        }

        // Add Relationship from Modal
        function addRelationFromModal() {
            const relationType = document.getElementById("relationTypeDropdown").value;
            const sourceClass = document.getElementById("relationSourceDropdown").value;
            const destinationClass = document.getElementById("relationDestinationDropdown").value;

            if (!relationType || !sourceClass || !destinationClass) {
                snackbar("All fields are required.");
                return;
            }

            fetch("/addRelation", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: relationType,
                    source: sourceClass,
                    destination: destinationClass
                })
            })
                .then(response => {
                    if (response.ok) {
                        getRelationList();
                        drawRelationshipLines();
                        closeAddRelationModal();
                    } else {
                        snackbar("Failed to add relationship.");
                    }
                })
                .catch(error => console.error("Error adding relationship:", error));
        }

        function updateRelationType(source, destination, newType) {
            fetch("/updateRelationType", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ source, destination, type: newType })
            })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to update relationship type");
                    snackbar("Relationship type updated successfully.");
                    getClassList(); // Reload the classes
                    drawRelationshipLines(); // Redraw the relationship lines
                })
                .catch(err => console.error("Error updating relationship type:", err));
        }

        /**
         * Adds a new field.
         * Adds the new field to the class details and updates the display.
         */
        function addField() {
            let fieldName = document.getElementById("classNameInput").value;
            // Add logic to handle the new field name
            console.log("New field name:", fieldName);
            // Add the new field to the list above the "Add Field" button
            let fieldsList = document.getElementById("fieldsList");
            let div = document.createElement("div");
            div.innerHTML = `- ${fieldName}`;
            fieldsList.appendChild(div);
            modal.style.display = "none";
        }

        function onkeydown_enter(event, func) {
            if (event.key === "Enter") {
                func();
            }
        }


        function deleteField(className, fieldName) {
            fetch("/deleteField", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fieldname: fieldName,
                    classname: className
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        /**
         * Adds a new method.
         * Adds the new method to the class details and updates the display.
         */
        function addMethod() {
            let methodName = document.getElementById("classNameInput").value;
            // Add logic to handle the new method name
            console.log("New method name:", methodName);
            // Add the new method to the list above the "Add Method" button
            let methodsList = document.getElementById("methodsList");
            let div = document.createElement("div");
            div.innerHTML = `+ ${methodName}`;
            methodsList.appendChild(div);
            modal.style.display = "none";
        }


        function deleteMethod(methodName, arity, className) {
            fetch("/deleteMethod", {
                method: "DELETE",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    methodname: methodName,
                    arity: arity,
                    classname: className
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function addMethodParam(event, target, methodname, arity, classname) {
            fetch("/addMethodParam", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    methodname: methodname,
                    paramname: target.value,
                    arity: arity,
                    classname: classname
                })
            })
                .then(res => {
                    if (res.status >= 400) {
                        target.value = "";
                        return res.json();
                    } else {
                        displayClassDetails(classname);
                    }
                })
                .then(data => snackbar(data.error))
                .catch(err => console.log(err));
        }

        function deleteMethodParameter(methodName, arity, parametername, className) {
            fetch("/deleteMethodParam", {
                method: "DELETE",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    methodname: methodName,
                    arity: arity,
                    parametername: parametername,
                    classname: className
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function renameMethodParam(oldname, newname, methodname, arity, classname) {
            fetch("/renameMethodParam", {
                method: "PUT",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldname: oldname,
                    newname: newname,
                    methodname: methodname,
                    arity: arity,
                    classname: classname
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        elem.value = methodName
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function handleErrorAction(action, tagId, error_text, yes_callback, no_callback) {
            switch (action) {
                case "showModal":
                    modal = document.getElementById(tagId);
                    e_text = document.getElementById("yesNoModalPrompt");
                    e_text.innerText = error_text;
                    btn_yes = document.getElementById("btnModalYes");
                    btn_no = document.getElementById("btnModalNo");
                    if (btn_yes) {
                        btn_yes.onclick = () => {
                            toggleVisibility([tagId]);
                            yes_callback();
                        }
                    }
                    if (btn_no) {
                        btn_no.onclick = () => {
                            toggleVisibility([tagId]);
                            no_callback();
                        };
                    }
                    toggleVisibility([tagId]);
            }
        }

        function newProject(override) {
            const fileNameInput = document.getElementById("newFileNameInput").value;

            fetch("/newproject", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: fileNameInput,
                    override_file: override
                })
            })
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        // Clear old project elements only after confirmation
                        clearOldProjectElements();
                        fileName = fileNameInput;
                        document.getElementById("saveFileNameInput").value = fileName;
                        closeNewModal();
                        getClassList();
                        getRelationList();
                    }
                })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => {
                            //clear elements for confirm
                            clearOldProjectElements();
                            newProject(true);
                        };
                        no_callback = () => {
                            document.getElementById("newFileNameInput").value = "";
                        };

                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    } else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.error("Error creating new project:", error));
        }

        /**
         * Saves the project with the given file name.
         * Prompts the user to enter a file name and saves the project.
         */
        function saveProject(override) {
            elem = document.getElementById("saveFileNameInput");

            fetch(`/saveproject`,
                {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: elem.value,
                        override: override
                    })
                }
            )
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json()
                    } else {
                        fileName = elem.value;
                        closeSaveModal();
                    }
                })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => saveProject(true);
                        no_callback = () => {
                            document.getElementById("saveFileNameInput").value = "";
                        };
                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    }
                    else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => {
                    console.error("Error saving project:", error);
                });
        }

        function clearOldProjectElements() {
            document.getElementById("ClassTable").innerHTML = "";
            document.getElementById("RelationTable").innerHTML = "";
            const classDetails = document.querySelectorAll(".ClassDetails");
            classDetails.forEach(details => details.remove());
            lines.forEach(line => line.remove());
            lines = [];
        }

        function loadProject(override) {
            fileName = document.getElementById("loadFileNameInput").value;

            fetch(`/loadfile?filename=${fileName}&override=${override}`)
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        // Clear old project elements only after confirmation
                        clearOldProjectElements();
                        closeLoadModal();
                        document.getElementById("saveFileNameInput").value = fileName;
                        getClassList();
                        getRelationList();
                    }
                })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => {
                            clearOldProjectElements(); // Clear elements if user confirms
                            loadProject(true);
                        };
                        no_callback = () => {
                            document.getElementById("loadFileNameInput").value = "";
                        };

                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    } else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => {
                    console.error("Error loading project:", error);
                });
        }

        function showLoadModal() {
            closeAllModals()
            document.getElementById("loadModal").style.display = "block";
        }

        function showExportModal() {
            closeAllModals()
            document.getElementById("exportModal").style.display = "block";
        }

        function closeLoadModal() {
            document.getElementById("exportModal").style.display = "none";
            document.getElementById("loadError").style.display = "none";
        }

        function closeExportModal() {
            document.getElementById("exportModal").style.display = "none";
            document.getElementById("exportError").style.display = "none";
        }

        function renameField(className, oldName, newName) {
            fetch("/renameField", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ classname: className, oldname: oldName, newname: newName })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        snackbar("Field renamed.");
                        displayClassDetails(className);
                        openEditClassDetails();
                    }
                });
        }

        function renameMethod(oldname, newname, arity, className) {
            fetch("/renameMethod", {
                method: "PUT",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    classname: className,
                    oldname: oldname,
                    newname: newname,
                    arity: arity
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        snackbar("Method renamed.");
                        displayClassDetails(className);
                        openEditClassDetails();
                    }
                });
        }

        function renameClass(target, classname) {
            const newname = target.value;
            if (classname === newname) {
                return;
            }

            fetch("/renameClass", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldname: classname,
                    newname: newname
                })
            })
                .then(res => {
                    if (res.ok) {
                        let existingDetailsDiv = document.getElementById(`ClassDetails-${classname}`);
                        if (existingDetailsDiv) {
                            existingDetailsDiv.id = `ClassDetails-${newname}`;
                            displayClassDetails(newname);
                        }
                        getClassList();
                        getRelationList();
                    } else {
                        return res.json();
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(reason => target.value = classname);
        }

        function inputBlur(event, func) {
            elem = event.target;
            if (elem.value === "") {
                func();
            }
        }

        function confirmQuit() {
            fetch("/quit", { method: "POST" })
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        window.close();
                    }
                })
                .then(data => {
                    if (data && data.action === "showModal") {
                        const yes_callback = () => {
                            fetch("/quit", { method: "POST", body: JSON.stringify({ override: true }) })
                                .then(() => window.close())
                                .catch(error => console.log(error));
                        };
                        const no_callback = () => {
                            const modal = document.getElementById("yesNoModal");
                            if (modal) {
                                modal.style.display = "none";
                            }
                        };
                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    }
                })
                .catch(error => console.log(error));
        }


        function deleteRelation(source, destination) {
            console.log(source, destination);
            fetch("/deleteRelation", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    source: source,
                    destination: destination
                })
            })
                .then(resp => {
                    console.log(resp);
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        getRelationList();
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.log(error));
        }

        let zIndexCounter = 1000; // Global counter for zIndex

        function makeElementDraggable(elementId, handleId) {
            const element = document.getElementById(elementId);
            const handle = document.getElementById(handleId);
            const content = document.getElementById("content");

            handle.onmousedown = function (e) {
                e.preventDefault();

                // Increment zIndexCounter and assign it to the dragged element
                zIndexCounter++;
                element.style.zIndex = zIndexCounter;

                const transform = content.style.transform;
                const match = transform.match(/scale\(([^)]+)\)/);
                const scale = match ? parseFloat(match[1]) : 1;

                let startX = e.clientX;
                let startY = e.clientY;
                let startLeft = parseFloat(element.style.left) || element.offsetLeft;
                let startTop = parseFloat(element.style.top) || element.offsetTop;

                function elementDrag(e) {
                    e.preventDefault();

                    const dx = (e.clientX - startX) / scale;
                    const dy = (e.clientY - startY) / scale;

                    element.style.left = (startLeft + dx) + "px";
                    element.style.top = (startTop + dy) + "px";

                    updateContentSize();
                    lines.forEach(line => line.position());
                }

                function closeDragElement() {
                    document.removeEventListener("mouseup", closeDragElement);
                    document.removeEventListener("mousemove", elementDrag);

                    // Keep the zIndex as the highest value when drag ends
                    element.style.zIndex = zIndexCounter;

                    updatePosition(elementId, element.style.left, element.style.top);
                }

                document.addEventListener("mousemove", elementDrag);
                document.addEventListener("mouseup", closeDragElement);
            };
        }

        let lines = []; // Store references to LeaderLine instances

        function drawLineByType(type, sourceElement, destinationElement) {
            const isSelfRelation = sourceElement === destinationElement;
            const baseOptions = {
                color: '#04AA6D',
                size: 4,
                path: 'fluid',
                startSocket: 'auto',
                endSocket: 'auto',
                zIndex: 3000 // Set a high z-index for the lines
            };

            // Self-relationship anchor positions (bottom arc)
            const startAnchor = isSelfRelation
                ? LeaderLine.pointAnchor(sourceElement, { x: '95%', y: '100%' })
                : sourceElement;

            const endAnchor = isSelfRelation
                ? LeaderLine.pointAnchor(destinationElement, { x: '5%', y: '100%' })
                : destinationElement;

            let line;
            switch (type.toLowerCase()) {
                case 'aggregation':
                    line = new LeaderLine(
                        startAnchor,
                        endAnchor,
                        {
                            ...baseOptions,
                            endPlug: 'square',
                            endPlugOutline: true,
                            endPlugSize: 1.5,
                            endPlugColor: '#000000',
                            outlineColor: '#04AA6D',
                            path: isSelfRelation ? 'arc' : baseOptions.path,
                            startSocket: isSelfRelation ? 'bottom' : baseOptions.startSocket,
                            endSocket: isSelfRelation ? 'bottom' : baseOptions.endSocket
                        }
                    );
                    break;

                case 'composition':
                    line = new LeaderLine(
                        startAnchor,
                        endAnchor,
                        {
                            ...baseOptions,
                            endPlug: 'square',
                            endPlugSize: 1.5,
                            path: isSelfRelation ? 'arc' : baseOptions.path,
                            startSocket: isSelfRelation ? 'bottom' : baseOptions.startSocket,
                            endSocket: isSelfRelation ? 'bottom' : baseOptions.endSocket
                        }
                    );
                    break;

                case 'inheritance':
                    line = new LeaderLine(
                        startAnchor,
                        endAnchor,
                        {
                            ...baseOptions,
                            color: '#000000',
                            outline: true,
                            endPlug: 'arrow3',
                            endPlugSize: 1.5,
                            endPlugOutline: true,
                            outlineColor: '#04AA6D',
                            path: isSelfRelation ? 'arc' : baseOptions.path,
                            startSocket: isSelfRelation ? 'bottom' : baseOptions.startSocket,
                            endSocket: isSelfRelation ? 'bottom' : baseOptions.endSocket
                        }
                    );
                    break;

                case 'realization':
                    line = new LeaderLine(
                        startAnchor,
                        endAnchor,
                        {
                            ...baseOptions,
                            dash: { len: 10, gap: 15, animation: true },
                            endPlug: 'arrow3',
                            endPlugSize: 1.5,
                            endPlugOutline: true,
                            endPlugColor: '#000000',
                            outlineColor: '#04AA6D',
                            path: isSelfRelation ? 'arc' : baseOptions.path,
                            startSocket: isSelfRelation ? 'bottom' : baseOptions.startSocket,
                            endSocket: isSelfRelation ? 'bottom' : baseOptions.endSocket
                        }
                    );
                    break;

                default:
                    console.error(`Unknown relationship type: ${type}`);
                    return null;
            }

            // Force the zIndex of the line's container
            if (line && line.line) {
                const lineContainer = line.line;
                lineContainer.style.zIndex = 3000;
                lineContainer.style.pointerEvents = 'none';
            }

            return line;
        }

        function drawRelationshipLines() {
            console.log("Drawing relationship lines...");

            // Clear existing lines
            lines.forEach(line => line.remove());
            lines = [];

            fetch('/relationList')
                .then(response => response.json())
                .then(data => {
                    console.log("Response from /relationList:", data);
                    const relationships = data.model.relationships;
                    relationships.forEach(relation => {
                        const sourceElement = document.getElementById(`ClassDetails-${relation.source}`);
                        const destinationElement = document.getElementById(`ClassDetails-${relation.destination}`);

                        // Skip relationships where either class is not in the DOM
                        if (!sourceElement || !destinationElement) {
                            console.log(`Skipping relation: ${relation.source} -> ${relation.destination}`);
                            return;
                        }

                        const line = drawLineByType(relation.relation_type, sourceElement, destinationElement);
                        if (line) {
                            lines.push(line);
                            console.log("Line drawn between:", relation.source, "and", relation.destination);
                        }
                    });
                })
                .catch(error => console.error("Error fetching relationships:", error));
        }

        /**
         * Fetches and displays the details of a class.
         * @param {string} className - The name of the class.
         */
        function displayClassDetails(className) {
            fetch(`/classdetails?name=${className}`)
                .then(response => response.json())
                .then(data => {
                    let existingDetailsDiv = document.getElementById(`ClassDetails-${className}`);
                    saved_x_pos = data.x_pos;
                    saved_y_pos = data.y_pos;

                    if (existingDetailsDiv) {
                        existingDetailsDiv.innerHTML = data.html;
                        existingDetailsDiv.style.display = "block";
                        if (saved_x_pos != 0 || saved_y_pos != 0) {
                            existingDetailsDiv.style.left = `${saved_x_pos}px`;
                            existingDetailsDiv.style.top = `${saved_y_pos}px`;
                        }
                        makeElementDraggable(existingDetailsDiv.id, `draggableBar-${className}`);
                    } else {
                        let detailsDiv = document.createElement("div");
                        detailsDiv.id = `ClassDetails-${className}`;
                        detailsDiv.className = "ClassDetails";
                        detailsDiv.innerHTML = data.html;
                        document.getElementById("content").appendChild(detailsDiv);
                        detailsDiv.style.display = "block";

                        if (saved_x_pos != 0 || saved_y_pos != 0) {
                            detailsDiv.style.left = `${saved_x_pos}px`;
                            detailsDiv.style.top = `${saved_y_pos}px`;
                        } else {
                            // Center in current visible viewport considering zoom
                            const container = document.getElementById("diagramContainer");
                            const content = document.getElementById("content");

                            const scaleMatch = content.style.transform.match(/scale\(([^)]+)\)/);
                            const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;

                            const scrollX = container.scrollLeft;
                            const scrollY = container.scrollTop;

                            const visibleCenterX = scrollX + container.clientWidth / 2;
                            const visibleCenterY = scrollY + container.clientHeight / 2;

                            const scaledX = visibleCenterX / scale;
                            const scaledY = visibleCenterY / scale;

                            const classWidth = 250;
                            const classHeight = 100;
                            const left = scaledX - classWidth / 2;
                            const top = scaledY - classHeight / 2;

                            detailsDiv.style.left = `${left}px`;
                            detailsDiv.style.top = `${top}px`;

                            // Only expand content area if needed
                            const rightEdge = left + classWidth;
                            const bottomEdge = top + classHeight;

                            const contentWidth = content.offsetWidth;
                            const contentHeight = content.offsetHeight;

                            if (rightEdge > contentWidth || bottomEdge > contentHeight || left < 0 || top < 0) {
                                updateContentSize();
                            }
                        }

                        makeElementDraggable(detailsDiv.id, `draggableBar-${className}`);
                    }

                    setTimeout(drawRelationshipLines, 100);
                    updateContentSize();
                });
        }


        //added 4-7 for saving position
        function updatePosition(elementId, leftPos, topPos) {
            //strip extra characters
            //13 should be leading "classname"
            let className = elementId.slice(13)
            let x_Pos = leftPos.slice(0, leftPos.length - 2)
            let y_Pos = topPos.slice(0, topPos.length - 2)
            fetch("/updateClassPosition", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                //second words capitalized to distinguish variables
                body: JSON.stringify({
                    classname: className,
                    x_pos: x_Pos,
                    y_pos: y_Pos
                })
            })
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        displayClassDetails(className);
                    }
                })
                .then(data => {
                    console.log(data);
                    if (data && data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.log(error))
        }

        function exportHTML() {
            const fileNameInput = document.getElementById("exportFileNameInput").value.trim();

            if (!fileNameInput) {
                snackbar("File name cannot be empty.");
                return;
            }

            const fileName = fileNameInput.endsWith(".html") ? fileNameInput : `${fileNameInput}.html`;

            const exportModal = document.getElementById("exportModal");
            const previousDisplay = exportModal.style.display;
            exportModal.style.display = "none";

            const htmlContent = document.documentElement.outerHTML;

            exportModal.style.display = previousDisplay;

            const blob = new Blob([htmlContent], { type: "text/html" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;

            link.click();

            URL.revokeObjectURL(link.href);
            closeExportModal();
            document.getElementById("exportFileNameInput").value = "";
        }


        function adjustZoom(zoomLevel) {
            const content = document.getElementById("content");
            const diagramContainer = document.getElementById("diagramContainer");

            const prevScale = parseFloat(content.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1);
            const newScale = zoomLevel / 100;

            const scrollLeftRatio = diagramContainer.scrollLeft / (content.offsetWidth * prevScale);
            const scrollTopRatio = diagramContainer.scrollTop / (content.offsetHeight * prevScale);

            updateContentSize();
            content.style.transform = `scale(${newScale})`;
            content.style.transformOrigin = "0 0";

            diagramContainer.scrollLeft = scrollLeftRatio * (content.offsetWidth * newScale);
            diagramContainer.scrollTop = scrollTopRatio * (content.offsetHeight * newScale);
            lines.forEach(line => line.position());
        }

        document.getElementById("diagramContainer").addEventListener("scroll", () => {
            lines.forEach(line => line.position());
        });

        function updateContentSize() {
            const content = document.getElementById("content");
            const classes = document.querySelectorAll(".ClassDetails");

            let maxWidth = 0;
            let maxHeight = 0;

            classes.forEach(cls => {
                const rect = cls.getBoundingClientRect();
                const right = cls.offsetLeft + cls.offsetWidth;
                const bottom = cls.offsetTop + cls.offsetHeight;

                if (right > maxWidth) maxWidth = right;
                if (bottom > maxHeight) maxHeight = bottom;
            });

            content.style.width = `${maxWidth}px`;
            content.style.height = `${maxHeight}px`;
        }

        function showRecenterModal() {
            closeAllModals();
            const dropdown = document.getElementById("recenterClassDropdown");
            dropdown.innerHTML = "";

            const classElements = document.querySelectorAll(".ClassDetails");
            classElements.forEach(el => {
                const className = el.id.replace("ClassDetails-", "");
                const option = document.createElement("option");
                option.value = className;
                option.text = className;
                dropdown.appendChild(option);
            });

            document.getElementById("recenterModal").style.display = "block";
        }


        function recenterToSelectedClass() {
            const selectedClass = document.getElementById("recenterClassDropdown").value;
            const classElement = document.getElementById(`ClassDetails-${selectedClass}`);
            const container = document.getElementById("diagramContainer");
            const content = document.getElementById("content");

            if (!classElement) return;

            // Ensure content dimensions are updated
            updateContentSize();

            const scaleMatch = content.style.transform.match(/scale\(([^)]+)\)/);
            const scale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;

            const centerX = (container.scrollLeft + containerWidth / 2) / scale;
            const centerY = (container.scrollTop + containerHeight / 2) / scale;

            const classWidth = classElement.offsetWidth;
            const classHeight = classElement.offsetHeight;

            // Calculate new position
            let newLeft = centerX - classWidth / 2;
            let newTop = centerY - classHeight / 2;

            const contentWidth = content.offsetWidth / scale;
            const contentHeight = content.offsetHeight / scale;

            newLeft = Math.max(0, Math.min(newLeft, contentWidth - classWidth));
            newTop = Math.max(0, Math.min(newTop, contentHeight - classHeight));

            // Move the class
            classElement.style.left = `${newLeft}px`;
            classElement.style.top = `${newTop}px`;

            // Update the position in the backend
            fetch("/updateClassPosition", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    classname: selectedClass,
                    x_pos: newLeft,
                    y_pos: newTop
                })
            })
                .then(() => {
                    const zoomSlider = document.getElementById("zoomSlider");
                    adjustZoom(zoomSlider.value);
                    closeAllModals();
                })
                .catch(error => console.error("Error updating class position:", error));
        }


        function adjustClassDetailsPosition(className) {
            const detailsDiv = document.getElementById(`ClassDetails-${className}`);
            const container = document.getElementById("diagramContainer");

            if (detailsDiv) {
                const rect = detailsDiv.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();

                // Ensure the modal stays within the visible area of the container
                if (rect.bottom > containerRect.bottom) {
                    detailsDiv.style.top = `${parseFloat(detailsDiv.style.top) - (rect.bottom - containerRect.bottom)}px`;
                }
                if (rect.top < containerRect.top) {
                    detailsDiv.style.top = `${parseFloat(detailsDiv.style.top) + (containerRect.top - rect.top)}px`;
                }
            }
        }

        function showEditClassModal() {
            closeAllModals();
            const dropdown = document.getElementById("editClassDropdown");
            dropdown.innerHTML = ""; // Clear existing options

            // Fetch the list of classes and populate the dropdown
            fetch("/classlist")
                .then(response => response.json())
                .then(data => {
                    console.log("Classlist response:", data); // Debug log

                    // Extract class names from the `data.html` property
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data.html, "text/html");
                    const classButtons = doc.querySelectorAll("button");
                    const classes = Array.from(classButtons).map(button => button.textContent.trim());

                    if (classes.length > 0) {
                        classes.forEach(className => {
                            const option = document.createElement("option");
                            option.value = className;
                            option.textContent = className;
                            dropdown.appendChild(option);
                        });
                    } else {
                        console.error("No classes found in the response.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching class list:", error);
                });

            document.getElementById("editClassModal").style.display = "block";
        }

        function closeEditClassModal() {
            document.getElementById("editClassModal").style.display = "none";
        }

        function openEditClassDetails() {
            const selectedClass = document.getElementById("editClassDropdown").value;
            if (!selectedClass) return;

            fetch(`/getClassData?name=${selectedClass}`)
                .then(response => response.json())
                .then(data => {
                    // Populate class name field
                    document.getElementById("editableClassName").value = selectedClass;

                    // ===== Fields =====
                    const fieldsList = document.getElementById("existingFieldsList");
                    fieldsList.innerHTML = "";
                    data.fields.forEach(field => {
                        const fieldDiv = document.createElement("div");

                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = field.name;
                        input.className = "editable-field";

                        const label = document.createTextNode(` (${field.type})`);

                        const button = document.createElement("button");
                        button.textContent = "Rename";
                        button.onclick = () => { /* Rename field logic */ };

                        fieldDiv.appendChild(input);
                        fieldDiv.appendChild(label);
                        fieldDiv.appendChild(button);
                        fieldsList.appendChild(fieldDiv);
                    });

                    // ===== Methods =====
                    const methodsList = document.getElementById("existingMethodsList");
                    methodsList.innerHTML = "";
                    data.methods.forEach(method => {
                        const methodDiv = document.createElement("div");

                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = method.name;
                        input.className = "editable-method";

                        const paramText = method.params.map(p => `${p.name}:${p.type}`).join(", ");
                        const label = document.createTextNode(`(${paramText}) ‚Üí ${method.return_type}`);

                        const button = document.createElement("button");
                        button.textContent = "Rename";
                        button.onclick = () => { /* Rename method logic */ };

                        methodDiv.appendChild(input);
                        methodDiv.appendChild(label);
                        methodDiv.appendChild(button);
                        methodsList.appendChild(methodDiv);
                    });

                    // ===== Relationships =====
                    const relationshipsList = document.getElementById("existingRelationshipsList");
                    relationshipsList.innerHTML = "";
                    data.relationships.forEach(rel => {
                        const relDiv = document.createElement("div");

                        const source = document.createTextNode(`Source: ${rel.source}`);
                        const destination = document.createTextNode(` ‚Üí Destination: ${rel.destination}`);

                        const dropdown = document.createElement("select");
                        ["AGGREGATION", "COMPOSITION", "INHERITANCE", "REALIZATION"].forEach(type => {
                            const option = document.createElement("option");
                            option.value = type;
                            option.textContent = type;
                            if (type === rel.relation_type) option.selected = true;
                            dropdown.appendChild(option);
                        });

                        dropdown.onchange = () => {
                            updateRelationType(rel.source, rel.destination, dropdown.value);
                        };

                        relDiv.appendChild(source);
                        relDiv.appendChild(destination);
                        relDiv.appendChild(dropdown);
                        relationshipsList.appendChild(relDiv);
                    });

                    // Show modal
                    document.getElementById("editClassDetailsModal").style.display = "block";
                })
                .catch(err => console.error("Error fetching class data:", err));
        }

        function closeEditClassDetailsModal() {
            document.getElementById("editClassDetailsModal").style.display = "none";
        }

        function addFieldToClass() {
            const selectedClass = document.getElementById("editClassDropdown").value;
            const fieldName = document.getElementById("newFieldName").value;
            const fieldType = document.getElementById("newFieldType").value;

            if (!fieldName || !fieldType) {
                snackbar("Field name and type are required.");
                return;
            }

            fetch("/addField", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fieldname: fieldName,
                    type: fieldType,
                    classname: selectedClass
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        openEditClassDetails(); // Refresh modal content
                        displayClassDetails(selectedClass); // Refresh class box
                        document.getElementById("newFieldName").value = "";
                        document.getElementById("newFieldType").value = "";
                    }
                })
                .catch(err => console.error("Error adding field:", err));
        }



        function addMethodToClass() {
            const selectedClass = document.getElementById("editClassDropdown").value;
            const methodName = document.getElementById("newMethodName").value;
            const returnType = document.getElementById("newMethodReturnType").value;
            const params = document.getElementById("newMethodParams").value;

            if (!methodName || !returnType) {
                snackbar("Method name and return type are required.");
                return;
            }

            fetch("/addMethod", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    methodname: methodName,
                    returntype: returnType,
                    paramlist: params || "",
                    classname: selectedClass
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        openEditClassDetails(); // Refresh modal content
                        displayClassDetails(selectedClass); // Refresh class box
                        document.getElementById("newMethodName").value = "";
                        document.getElementById("newMethodReturnType").value = "";
                        document.getElementById("newMethodParams").value = "";
                    }
                })
                .catch(err => console.error("Error adding method:", err));
        }



        function renameClassFromModal() {
            const oldName = document.getElementById("editClassDropdown").value;
            const newName = document.getElementById("editableClassName").value;

            if (!newName || oldName === newName) {
                snackbar("Enter a different new class name.");
                return;
            }

            fetch("/renameClass", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    oldname: oldName,
                    newname: newName
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        snackbar("Class renamed successfully.");
                        getClassList(); // Refresh class dropdowns
                        document.getElementById("editClassDropdown").value = newName;
                        openEditClassDetails(); // Reload modal with new name
                    }
                });
        }


        function updateModalClassNameDisplay() {
            const newName = document.getElementById("editableClassName").value.trim();
            const selectedClass = document.getElementById("editClassDropdown").value;

            const header = document.querySelector(`#ClassDetails-${selectedClass} .class-name-header`);
            if (header) {
                header.textContent = newName || selectedClass;
            }
        }




    </script>
</body>

</html>