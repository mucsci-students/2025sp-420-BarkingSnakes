<!DOCTYPE html>
<html>
<link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêç</text></svg>">

<head>
    <title>BS-UML</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<head>
    <script src="https://cdn.jsdelivr.net/npm/leader-line"></script>
</head>

<body style="background-color: #0e1113;">
    <div id="toolbar">
        <div id="addButtons">
            <button onclick="showAddClassModal()">Add Class</button>
            <button onclick="showAddRelationModal()">Add Relationship</button>
        </div>
        <div id="otherButtons">
            <button onclick="toggleLists()">Lists</button>
            <button onclick="showNewModal()">New</button>
            <button onclick="showSaveModal()">Save</button>
            <button onclick="showLoadModal()">Load</button>
            <button onclick="confirmQuit()">Quit</button>
        </div>
    </div>
    <div id="content">
    </div>

    <div id="ClassTable" style="display: none;">
        <!-- <table id="Data">
        </table> -->
    </div>

    <div id="RelationTable" style="display: none;">
        <!-- <table id="RelationData"> -->
        <!-- Relation data will be inserted here -->
        <!-- </table> -->
    </div>

    <div id="ClassDetails" style="display: none;">
        <button class="close" onclick="closeClassDetails()">&times;</button>
        <!-- Class details will be displayed here -->
    </div>

    <!-- The Modal for creating a new project -->
    <div id="newModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewModal()">&times;</span>
            <h2>New File</h2>
            <p>Enter File Name:</p>
            <input type="text" id="newFileNameInput" />
            <button onclick="newProject(false)">Create Project</button>
        </div>
    </div>

    <!-- The Modal for saving the project -->
    <div id="saveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSaveModal()">&times;</span>
            <h2>Save File</h2>
            <p>Enter File Name:</p>
            <input type="text" id="saveFileNameInput" />
            <button onclick="saveProject(false)">Save</button>
        </div>
    </div>

    <div id="loadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoadModal()">&times;</span>
            <h2>Load File</h2>
            <p>Enter File Name:</p>
            <input type="text" id="loadFileNameInput" />
            <button onclick="loadProject(false)">Load</button>
            <p id="loadError" style="color: red; display: none;">Incorrect file name/type</p>
        </div>
    </div>
    <!-- Modal for asking the user if they want to override an existing file. -->
    <div id="yesNoModal" class="modal">
        <div class="modal-content">
            <p id="yesNoModalPrompt"></p>
            <div>
                <span><button id="btnModalYes" onclick="">Yes</button></span>
                <span><button id="btnModalNo" onclick="toggleVisibility(['yesNoModal'])">No</button></span>
            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div id="addClassModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddClassModal()">&times;</span>
            <h2>Add Class</h2>
            <p>Enter Class Name:</p>
            <input type="text" id="addClassInput" />
            <button onclick="addClassFromModal()">Add Class</button>
        </div>
    </div>

    <!-- Add Relationship Modal -->
    <div id="addRelationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddRelationModal()">&times;</span>
            <h2>Add Relationship</h2>
            <p>Select Relationship Type:</p>
            <select id="relationTypeDropdown">
                <option value="Inheritance">Inheritance</option>
                <option value="Aggregation">Aggregation</option>
                <option value="Composition">Composition</option>
                <option value="Realization">Realization</option>
            </select>
            <p>Select Source Class:</p>
            <select id="relationSourceDropdown"></select>
            <p>Select Destination Class:</p>
            <select id="relationDestinationDropdown"></select>
            <button onclick="addRelationFromModal()">Add Relationship</button>
        </div>
    </div>

    <div id="snackbar">Some text some message..</div>
    <style>
        body {
            background-color: #0e1113;
            padding-top: 60px;
        }

        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #333;
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            z-index: 2;
        }

        #addButtons {
            display: flex;
            gap: 10px;
            margin-right: auto;
        }

        #otherButtons {
            display: flex;
            gap: 10px;
            margin: 0 auto;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        #toolbar button {
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }

        #toolbar button:hover {
            background-color: #028a5e;
        }


        #ClassList {
            top: 20px;
            background-color: #04AA6D;
        }

        #RelationList {
            top: 80px;
            background-color: #04AA6D;
        }

        #ClassTable,
        #RelationTable {
            padding: 15px;
            background-color: #04AA6D;
            color: white;
            margin-bottom: 20px;
            position: fixed;
            left: 0;
            width: 20%;
        }

        #ClassTable {
            top: 0px;
            /* Position below the toolbar */
            position: relative;
            /* Allow it to expand dynamically */
        }

        #RelationTable {
            margin-top: 20px;
            /* Add spacing between ClassList and RelationList */
            position: relative;
            /* Ensure it moves down as ClassList expands */
        }

        .RelationData {
            width: 100%;
            text-align: center;
        }

        .draggable-bar {
            width: 100%;
            height: 18px;
            background-color: #04AA6D;
            cursor: move;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        #ClassDetails {
            position: fixed;
            /* Changed from absolute to fixed */
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px;
            background-color: #333;
            color: white;
            border-radius: 10px;
            width: 20%;
            text-align: center;
            display: none;
        }

        .ClassDetails {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px;
            background-color: #333;
            color: white;
            border-radius: 10px;
            width: 15%;
            text-align: center;
            display: none;
            font-size: 0.9em;
        }

        .class-button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px;
            text-align: left;
            width: 100%;
            cursor: pointer;
        }

        .class-button:hover {
            background-color: #555;
        }

        .input-container {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: green;
            font-size: 18px;
        }


        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #333;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            color: white;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }

        .input-mode-view {
            margin-top: 10px;
            background: transparent;
            color: white;
            border: none;
        }

        .edit-button {
            position: absolute;
            top: 20px;
            left: 10px;
            background-color: #04AA6D;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.2s;
        }

        .edit-button:hover {
            background-color: #028a5e;
            transform: scale(1.1);
        }

        .hidden {
            display: none;
        }

        #cntrAddClass>input {
            background: #333;
            width: 100%
        }

        #loadError {
            color: red;
            display: none;
            margin-top: 10px;
        }

        .delete-icon {
            color: red;
            font-size: 18px;
            transition: all 0.2s ease-in-out;
        }

        .delete-icon:hover {
            text-shadow: 0 2px 10px rgba(255, 0, 0, 0.7);
            transform: scale(1.1);
            cursor: pointer;
        }


        /* START SNACKBAR https://www.w3schools.com/howto/howto_js_snackbar.asp */
        /* The snackbar - position it at the bottom and in the middle of the screen */
        #snackbar {
            visibility: hidden;
            /* Hidden by default. Visible on click */
            min-width: 250px;
            /* Set a default minimum width */
            margin-left: -125px;
            /* Divide value of min-width by 2 */
            background-color: #f70909;
            /* Black background color */
            color: #fff;
            /* White text color */
            text-align: center;
            /* Centered text */
            border-radius: 2px;
            /* Rounded borders */
            padding: 16px;
            /* Padding */
            position: fixed;
            /* Sit on top of the screen */
            z-index: 1;
            /* Add a z-index if needed */
            left: 50%;
            /* Center the snackbar */
            bottom: 30px;
            /* 30px from the bottom */
        }

        /* Show the snackbar when clicking on a button (class added with JavaScript) */
        #snackbar.show {
            visibility: visible;
            /* Show the snackbar */
            /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
        However, delay the fade out process for 2.5 seconds */
            -webkit-animation: fadein 0.5s, fadeout 0.5s 4.5s;
            animation: fadein 0.5s, fadeout 0.5s 4.5s;
        }

        .delete-icon {
            color: red;
            font-size: 18px;
            transition: all 0.2s ease-in-out;
        }

        .delete-icon:hover {
            text-shadow: 0 2px 10px rgba(255, 0, 0, 0.7);
            transform: scale(1.1);
            cursor: pointer;
        }

        /* Animations to fade the snackbar in and out */
        @-webkit-keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* END SNACKBAR https://www.w3schools.com/howto/howto_js_snackbar.asp */

        input.class-name {
            background: #333;
            color: white;
            width: 100%;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            border: none;
        }
    </style>

    <script>
        function snackbar(text) {
            // Get the snackbar DIV
            var x = document.getElementById("snackbar");

            // Add the "show" class to DIV
            x.className = "show";
            x.innerText = text;

            // After 3 seconds, remove the show class from DIV
            setTimeout(function () { x.className = x.className.replace("show", ""); }, 5000);
        }


        /**
         * Added a "Lists" button to toggle the visibility of the class and relation lists.
         */
        function toggleLists() {
            let classTable = document.getElementById("ClassTable");
            let relationTable = document.getElementById("RelationTable");

            if (classTable.style.display === "none" || classTable.style.display === "") {
                classTable.style.display = "block";
                relationTable.style.display = "block";
                getClassList();
                getRelationList();
            } else {
                classTable.style.display = "none";
                relationTable.style.display = "none";
            }
        }

        /**
         * Fetches and displays the class list.
         * Sends a request to the server to get the list of classes.
         */
        function getClassList() {
            fetch('/classlist')
                .then(response => response.json())
                .then(data => {
                    document.getElementById("ClassTable").innerHTML = data.html;
                    const classButtons = document.querySelectorAll("#ClassTable .class-button");
                    classButtons.forEach(button => {
                        const className = button.textContent.trim();
                        displayClassDetails(className);
                    });
                });
        }

        /**
         * Displays the classes upon startup
         */
        document.addEventListener("DOMContentLoaded", () => {
            getClassList();
        });

        function toggleVisibility(ids) {
            console.log("Toggle: " + ids);
            ids.forEach(id => {
                const elem = document.getElementById(id);
                if (!elem) {
                    console.error(`Element with ID '${id}' not found.`);
                    return;
                }
                const input = elem.getElementsByTagName("input")[0];
                console.log(elem.style.display, elem);
                if (elem.style.display === "none" || elem.style.display === "" || elem.style.display === null) {
                    elem.style.display = "block";
                    if (input) input.focus();
                } else {
                    elem.style.display = "none";
                }
            });
        }

        /**
         * Fetches and displays the relation list.
         * Sends a request to the server to get the list of relations.
         */
        function getRelationList() {
            fetch("/relationList")
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById("RelationTable");
                    container.innerHTML = data.html; // Update the relation table
                    drawRelationshipLines(); // Redraw the lines after updating the table
                })
                .catch(error => console.error("Error fetching relation list:", error));
        }


        // Get the modal
        var modal = document.getElementById("myModal");
        var saveModal = document.getElementById("saveModal");
        var newModal = document.getElementById("newModal");
        var addClassModal = document.getElementById("addClassModal");
        var addRelationModal = document.getElementById("addRelationModal");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        var fileName;

        /**
         * Shows the modal for adding a class, relation, field, or method.
         * @param {string} type - The type of item to add.
         */
        function showModal(type) {
            if (type === 'class') {
                document.getElementById("modalPrompt").innerText = "Enter Class Name:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addClass;
            } else if (type === 'relation') {
                document.getElementById("modalPrompt").innerText = "Enter Source Class and Target Class:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addRelation;
            } else if (type === 'field') {
                document.getElementById("modalPrompt").innerText = "Enter Field Name:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addField;
            } else if (type === 'method') {
                document.getElementById("modalPrompt").innerText = "Enter Method Name:";
                document.getElementById("classNameInput").value = "";
                document.getElementById("modalSubmitButton").onclick = addMethod;
            }
            modal.style.display = "block";
        }

        /**
         * Shows the new project modal.
         */
        function showNewModal() {
            closeAllModals();
            newModal.style.display = "block";
        }

        /**
         * Closes the new project modal.
         */
        function closeNewModal() {
            newModal.style.display = "none";
        }

        /**
         * Shows the save modal.
         */
        function showSaveModal() {
            closeAllModals();
            document.getElementById("saveModal").style.display = "block";
        }

        /**
         * Closes the save modal.
         */
        function closeSaveModal() {
            saveModal.style.display = "none";
        }

        /**
         * Toggles on/off the edit mode on the class details
         */
        function toggleEditMode(className) {
            const addFieldContainer = document.getElementById(`addFieldContainer-${className}`);
            const deleteFieldbtn = document.getElementById(`deleteFieldbtn-${className}`);
            const fieldTextInpt = document.getElementById(`umlfield-${className}`);
            const addMethodContainer = document.getElementById(`addMethodContainer-${className}`);
            const classTextInpt = document.getElementById(`classname-${className}`);
            const isHidden = addFieldContainer.classList.contains('hidden');
            let editModeState = false;

            if (isHidden) {
                if (addFieldContainer) {
                    addFieldContainer.classList.remove('hidden');
                }

                if (deleteFieldbtn) {
                    deleteFieldbtn.classList.remove('hidden');
                }

                if (addMethodContainer) {
                    addMethodContainer.classList.remove('hidden');
                }

                if (fieldTextInpt) {
                    fieldTextInpt.readOnly = false;
                }

                if (classTextInpt) {
                    classTextInpt.readOnly = false;
                }
                editModeState = true; // Set edit mode to true
            } else {
                if (addFieldContainer) {
                    addFieldContainer.classList.add('hidden');
                }

                if (deleteFieldbtn) {
                    deleteFieldbtn.classList.add('hidden');
                }

                if (addMethodContainer) {
                    addMethodContainer.classList.add('hidden');
                }

                if (fieldTextInpt) {
                    fieldTextInpt.readOnly = true;
                }

                if (classTextInpt) {
                    classTextInpt.readOnly = true;
                }

                editModeState = false; // Set edit mode to false
            }

            setTimeout(drawRelationshipLines, 100);
        }

        /**
         * Closes the class details.
         */
        function closeClassDetails(className) {
            let detailsDiv = document.getElementById(`ClassDetails-${className}`);
            if (detailsDiv) {
                detailsDiv.style.display = "none";
                console.log(`ClassDetails-${className} closed.`); // Debug log
            } else {
                console.log(`ClassDetails-${className} not found.`); // Debug log
            }

            // Remove lines associated with the closed class
            lines = lines.filter(line => {
                const isStartClass = line.sourceElement && line.sourceElement.id === `ClassDetails-${className}`;
                const isEndClass = line.destinationElement && line.destinationElement.id === `ClassDetails-${className}`;

                console.log(`Checking line: Source ID = ${line.sourceElement?.id}, Destination ID = ${line.destinationElement?.id}`); // Debug log

                if (isStartClass || isEndClass) {
                    console.log(`Removing line connected to ClassDetails-${className}`); // Debug log
                    line.remove(); // Remove the line from the DOM
                    return false; // Exclude this line from the `lines` array
                }
                return true; // Keep this line in the `lines` array
            });

            console.log("Remaining lines:", lines); // Debug log
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
            closeSaveModal();
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
            if (event.target == saveModal) {
                saveModal.style.display = "none";
            }
            if (event.target == loadModal) {
                loadModal.style.display = "none";
            }
            if (event.target == newModal) {
                newModal.style.display = "none";
            }
            if (event.target == addClassModal) {
                closeAddClassModal();
            }
            if (event.target == addRelationModal) {
                closeAddRelationModal();
            }
        }

        function closeAllModals() {
            const modals = document.querySelectorAll(".modal");
            modals.forEach(modal => {
                modal.style.display = "none";
            });
        }

        // Show Add Class Modal
        function showAddClassModal() {
            closeAllModals();
            document.getElementById("addClassModal").style.display = "block";
        }

        // Close Add Class Modal
        function closeAddClassModal() {
            document.getElementById("addClassModal").style.display = "none";
        }

        // Add Class from Modal
        function addClassFromModal() {
            const className = document.getElementById("addClassInput").value;
            if (!className) {
                snackbar("Class name cannot be empty.");
                return;
            }

            fetch("/addClass", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ classname: className })
            })
                .then(response => {
                    if (response.ok) {
                        getClassList();
                        closeAddClassModal();
                    } else {
                        snackbar("Failed to add class.");
                    }
                })
                .catch(error => console.error("Error adding class:", error));
        }

        function deleteClass(classname, override) {
            fetch("/deleteclass", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    classname: classname,
                    override: override
                })
            })
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        getClassList();
                        getRelationList();
                    }

                })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => deleteClass(classname, true);
                        no_callback = () => {
                        };

                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    }
                    else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.log(error))
        }


        // Show Add Relationship Modal
        function showAddRelationModal() {
            closeAllModals(); // Close any open modals
            document.getElementById("addRelationModal").style.display = "block";

            // Populate dropdowns with class names
            fetch("/classlist")
                .then(response => response.json())
                .then(data => {
                    const classNames = data.html.match(/<button.*?>(.*?)<\/button>/g).map(btn => btn.replace(/<.*?>/g, ''));
                    const sourceDropdown = document.getElementById("relationSourceDropdown");
                    const destinationDropdown = document.getElementById("relationDestinationDropdown");

                    sourceDropdown.innerHTML = "";
                    destinationDropdown.innerHTML = "";

                    classNames.forEach(className => {
                        const option = `<option value="${className}">${className}</option>`;
                        sourceDropdown.innerHTML += option;
                        destinationDropdown.innerHTML += option;
                    });
                });
        }

        // Close Add Relationship Modal
        function closeAddRelationModal() {
            document.getElementById("addRelationModal").style.display = "none";
        }

        // Add Relationship from Modal
        function addRelationFromModal() {
            const relationType = document.getElementById("relationTypeDropdown").value;
            const sourceClass = document.getElementById("relationSourceDropdown").value;
            const destinationClass = document.getElementById("relationDestinationDropdown").value;

            if (!relationType || !sourceClass || !destinationClass) {
                snackbar("All fields are required.");
                return;
            }

            fetch("/addRelation", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: relationType,
                    source: sourceClass,
                    destination: destinationClass
                })
            })
                .then(response => {
                    if (response.ok) {
                        getRelationList();
                        drawRelationshipLines();
                        closeAddRelationModal();
                    } else {
                        snackbar("Failed to add relationship.");
                    }
                })
                .catch(error => console.error("Error adding relationship:", error));
        }

        /**
         * Adds a new field.
         * Adds the new field to the class details and updates the display.
         */
        function addField() {
            let fieldName = document.getElementById("classNameInput").value;
            // Add logic to handle the new field name
            console.log("New field name:", fieldName);
            // Add the new field to the list above the "Add Field" button
            let fieldsList = document.getElementById("fieldsList");
            let div = document.createElement("div");
            div.innerHTML = `- ${fieldName}`;
            fieldsList.appendChild(div);
            modal.style.display = "none";
        }

        function onkeydown_enter(event, func) {
            if (event.key === "Enter") {
                func();
            }
        }

        function addField2(event, elem1, elem2, className) {
            if (event.key === "Enter") {
                const fieldType = "string";
                fetch("/addField", {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fieldname: elem1,
                        classname: className,
                        type: elem2
                    })
                })
                    .then(resp => {
                        if (resp.status >= 400) {
                            elem.value = "";
                            return resp.json();
                        } else {
                            displayClassDetails(className);
                        }
                    })
                    .then(data => {
                        console.log(data);
                        snackbar(data.error);
                    })
                    .catch(error => console.log(error))
            }
        }

        function deleteField(className, fieldName) {
            fetch("/deleteField", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fieldname: fieldName,
                    classname: className
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        /**
         * Adds a new method.
         * Adds the new method to the class details and updates the display.
         */
        function addMethod() {
            let methodName = document.getElementById("classNameInput").value;
            // Add logic to handle the new method name
            console.log("New method name:", methodName);
            // Add the new method to the list above the "Add Method" button
            let methodsList = document.getElementById("methodsList");
            let div = document.createElement("div");
            div.innerHTML = `+ ${methodName}`;
            methodsList.appendChild(div);
            modal.style.display = "none";
        }

        function addMethod2(event, className) {
            if (event.key === "Enter") {
                let methodname = document.getElementById('newMethodName-' + className);
                let returntype = document.getElementById('newMethodType-' + className);
                let paramlist = document.getElementById('parameterListInpt-' + className)
                fetch("/addMethod", {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        methodname: methodname.value,
                        returntype: returntype.value,
                        paramlist: paramlist.value,
                        classname: className
                    })
                })
                    .then(resp => {
                        if (resp.status >= 400) {
                            elem.value = "";
                            return resp.json();
                        } else {
                            displayClassDetails(className);
                        }
                    })
                    .then(data => {
                        if (data && data.error) {
                            snackbar(data.error);
                        }
                    })
                    .catch(error => console.log(error))
            }
        }

        function deleteMethod(methodName, arity, className) {
            fetch("/deleteMethod", {
                method: "DELETE",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    methodname: methodName,
                    arity: arity,
                    classname: className
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function addMethodParam(event, target, methodname, arity, classname) {
            fetch("/addMethodParam", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    methodname: methodname,
                    paramname: target.value,
                    arity: arity,
                    classname: classname
                })
            })
                .then(res => {
                    if (res.status >= 400) {
                        target.value = "";
                        return res.json();
                    } else {
                        displayClassDetails(classname);
                    }
                })
                .then(data => snackbar(data.error))
                .catch(err => console.log(err));
        }

        function deleteMethodParameter(methodName, arity, parametername, className) {
            fetch("/deleteMethodParam", {
                method: "DELETE",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    methodname: methodName,
                    arity: arity,
                    parametername: parametername,
                    classname: className
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function renameMethodParam(oldname, newname, methodname, arity, classname) {
            fetch("/renameMethodParam", {
                method: "PUT",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldname: oldname,
                    newname: newname,
                    methodname: methodname,
                    arity: arity,
                    classname: classname
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        elem.value = methodName
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function handleErrorAction(action, tagId, error_text, yes_callback, no_callback) {
            switch (action) {
                case "showModal":
                    modal = document.getElementById(tagId);
                    e_text = document.getElementById("yesNoModalPrompt");
                    e_text.innerText = error_text;
                    btn_yes = document.getElementById("btnModalYes");
                    btn_no = document.getElementById("btnModalNo");
                    if (btn_yes) {
                        btn_yes.onclick = () => {
                            toggleVisibility([tagId]);
                            yes_callback();
                        }
                    }
                    if (btn_no) {
                        btn_no.onclick = () => {
                            toggleVisibility([tagId]);
                            no_callback();
                        };
                    }
                    toggleVisibility([tagId]);
            }
        }

        function newProject(override) {
            elem = document.getElementById("newFileNameInput")
            fetch("/newproject", {
                method: "Post",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: elem.value,
                    override_file: override
                })
            }).then(resp => {
                if (resp.status >= 400) {
                    return resp.json()
                } else {
                    fileName = elem.value;
                    document.getElementById("saveFileNameInput").value = fileName;
                    closeNewModal();
                    getClassList();
                    getRelationList();
                }
            })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => newProject(true);
                        no_callback = () => {
                            document.getElementById("newFileNameInput").value = "";
                        };

                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    }
                    else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.log(error))
        }

        /**
         * Saves the project with the given file name.
         * Prompts the user to enter a file name and saves the project.
         */
        function saveProject(override) {
            elem = document.getElementById("saveFileNameInput");

            fetch(`/saveproject`,
                {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: elem.value,
                        override: override
                    })
                }
            )
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json()
                    } else {
                        fileName = elem.value;
                        closeSaveModal();
                    }
                })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => saveProject(true);
                        no_callback = () => {
                            document.getElementById("saveFileNameInput").value = "";
                        };
                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    }
                    else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => {
                    console.error("Error saving project:", error);
                });
        }

        function loadProject(override) {
            fileName = document.getElementById("loadFileNameInput").value;
            // let loadError = document.getElementById("loadError");

            // if (!fileName.endsWith(".json")) {
            //     loadError.style.display = "block";
            //     return;
            // }

            fetch(`/loadfile?filename=${fileName}&override=${override}`)
                .then(resp => {
                    // if (!response.ok) {
                    //     throw new Error("File not found");
                    // }
                    // return response.json();
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        closeLoadModal();
                        document.getElementById("saveFileNameInput").value = fileName;
                        getClassList();
                        getRelationList();
                    }
                })
                .then(data => {
                    if (data.action) {
                        yes_callback = () => loadProject(true);
                        no_callback = () => {
                            document.getElementById("loadFileNameInput").value = "";
                        };

                        handleErrorAction(data.action, data.tagId, data.error, yes_callback, no_callback);
                    }
                    else if (data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => {
                    // loadError.style.display = "block";
                    console.error("Error loading project:", error);
                });
        }

        function showLoadModal() {
            closeAllModals()
            document.getElementById("loadModal").style.display = "block";
        }

        function closeLoadModal() {
            document.getElementById("loadModal").style.display = "none";
            document.getElementById("loadError").style.display = "none";
        }

        function renameField(target, elem, className, fieldName) {
            const newname = target.value;
            if (fieldName === newname) {
                return;
            }

            fetch("/renameField", {
                method: "post",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    classname: className,
                    oldname: fieldName,
                    newname: newname
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        elem.value = fieldName
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function renameMethod(oldname, newname, arity, className) {
            fetch("/renameMethod", {
                method: "PUT",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldname: oldname,
                    newname: newname,
                    arity: arity,
                    classname: className
                })
            })
                .then(resp => {
                    return resp.json();
                })
                .then(data => {
                    if (data.error) {
                        elem.value = methodName
                        snackbar(data.error);
                    } else {
                        displayClassDetails(className);
                    }
                })
        }

        function renameClass(target, classname) {
            const newname = target.value;
            if (classname === newname) {
                return;
            }

            fetch("/renameClass", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldname: classname,
                    newname: newname
                })
            })
                .then(res => {
                    if (res.ok) {
                        let existingDetailsDiv = document.getElementById(`ClassDetails-${classname}`);
                        if (existingDetailsDiv) {
                            existingDetailsDiv.id = `ClassDetails-${newname}`;
                            displayClassDetails(newname);
                        }
                        getClassList();
                        getRelationList();
                    } else {
                        return res.json();
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(reason => target.value = classname);
        }

        function inputBlur(event, func) {
            elem = event.target;
            if (elem.value === "") {
                func();
            }
        }

        function confirmQuit() {
            var result = confirm("Are you sure you want to quit?")
            if (result) {
                fetch("/quit", { method: "POST" })
                    .then(res => window.close())
                    .catch(error => console.log(error))

            }
        }


        function deleteRelation(source, destination) {
            console.log(source, destination);
            fetch("/deleteRelation", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    source: source,
                    destination: destination
                })
            })
                .then(resp => {
                    console.log(resp);
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        getRelationList();
                    }
                })
                .then(data => {
                    if (data && data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.log(error));
        }

        function makeElementDraggable(elementId, handleId) {
            const element = document.getElementById(elementId);
            const handle = document.getElementById(handleId);
            let offsetX = 0, offsetY = 0, initialX = 0, initialY = 0;

            handle.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e.preventDefault();
                initialX = e.clientX;
                initialY = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e.preventDefault();
                offsetX = initialX - e.clientX;
                offsetY = initialY - e.clientY;
                initialX = e.clientX;
                initialY = e.clientY;
                element.style.top = (element.offsetTop - offsetY) + "px";
                element.style.left = (element.offsetLeft - offsetX) + "px";

                //for auto updating lines to make them dynamic
                lines.forEach(line => line.position());
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        let lines = []; // Store references to LeaderLine instances

        function drawLineByType(type, sourceElement, destinationElement) {
            switch (type.toLowerCase()) {
                case 'aggregation':
                    return new LeaderLine(
                        sourceElement,
                        destinationElement,
                        {
                            color: '#04AA6D',
                            endPlugOutline: true,
                            endPlugSize: 1.5,
                            endPlugColor: "#000000",
                            outlineColor: '#04AA6D',
                            size: 4,
                            endPlug: 'square',
                            path: 'fluid',
                            startSocket: 'auto',
                            endSocket: 'auto'
                        }
                    );
                case 'composition':
                    return new LeaderLine(
                        sourceElement,
                        destinationElement,
                        {
                            color: '#04AA6D',
                            endPlugSize: 1.5,
                            size: 4,
                            endPlug: 'square',
                            path: 'fluid',
                            startSocket: 'auto',
                            endSocket: 'auto'
                        }
                    );
                case 'inheritance':
                    return new LeaderLine(
                        sourceElement,
                        destinationElement,
                        {
                            color: '#000000',
                            outline: true,
                            endPlugOutline: true,
                            endPlugSize: 1.5,
                            outlineColor: '#04AA6D',
                            size: 4,
                            endPlug: 'arrow3',
                            path: 'fluid',
                            startSocket: 'auto',
                            endSocket: 'auto'
                        }
                    );
                case 'realization':
                    return new LeaderLine(
                        sourceElement,
                        destinationElement,
                        {
                            color: '#04AA6D',
                            dash: { len: 10, gap: 15, animation: true },
                            endPlugOutline: true,
                            endPlugSize: 1.5,
                            endPlugColor: "#000000",
                            outlineColor: '#04AA6D',
                            size: 4,
                            endPlug: 'arrow3',
                            path: 'fluid',
                            startSocket: 'auto',
                            endSocket: 'auto'
                        }
                    );
                default:
                    console.error(`Unknown relationship type: ${type}`);
                    return null;
            }
        }

        function drawRelationshipLines() {
            console.log("Drawing relationship lines...");

            // Clear existing lines
            lines.forEach(line => line.remove());
            lines = [];

            fetch('/relationList')
                .then(response => response.json())
                .then(data => {
                    console.log("Response from /relationList:", data);
                    const relationships = data.model.relationships;
                    relationships.forEach(relation => {
                        const sourceElement = document.getElementById(`ClassDetails-${relation.source}`);
                        const destinationElement = document.getElementById(`ClassDetails-${relation.destination}`);

                        if (!sourceElement || !destinationElement) {
                            console.error(`One or both elements not found for relation:`, relation);
                            return;
                        }

                        const line = drawLineByType(relation.relation_type, sourceElement, destinationElement);
                        if (line) {
                            lines.push(line);
                            console.log("Line drawn between:", relation.source, "and", relation.destination);
                        }
                    });
                })
                .catch(error => console.error("Error fetching relationships:", error));
        }

        /**
         * Fetches and displays the details of a class.
         * @param {string} className - The name of the class.
         */
        function displayClassDetails(className) {
            fetch(`/classdetails?name=${className}`)
                .then(response => response.json())
                .then(data => {
                    let existingDetailsDiv = document.getElementById(`ClassDetails-${className}`);
                    //get the class's position
                    saved_x_pos = data.x_pos;
                    saved_y_pos = data.y_pos;
                    if (existingDetailsDiv) {
                        existingDetailsDiv.innerHTML = data.html;
                        existingDetailsDiv.style.display = "block";
                        // if class of same name exists when a new project is loaded,
                        // this will get called here since a new div is not currently
                        // created when loading a project if the names match
                        if (saved_x_pos != 0 || saved_y_pos != 0) {
                            existingDetailsDiv.style.left = `${saved_x_pos}px`;
                            existingDetailsDiv.style.top = `${saved_y_pos}px`;
                        }
                        makeElementDraggable(existingDetailsDiv.id, `draggableBar-${className}`);
                    } else {
                        let detailsDiv = document.createElement("div");
                        detailsDiv.id = `ClassDetails-${className}`;
                        detailsDiv.className = "ClassDetails";
                        detailsDiv.innerHTML = data.html;
                        document.body.appendChild(detailsDiv);
                        detailsDiv.style.display = "block";
                        // only update the pos from saved if the class was moved
                        if (saved_x_pos != 0 || saved_y_pos != 0) {
                            detailsDiv.style.left = `${saved_x_pos}px`;
                            detailsDiv.style.top = `${saved_y_pos}px`;
                        }
                        makeElementDraggable(detailsDiv.id, `draggableBar-${className}`);
                    }
                    //makes sure lines are rendered 
                    setTimeout(drawRelationshipLines, 100);
                });
        }
        //added 4-7 for saving position
        function updatePosition(elementId, leftPos, topPos) {
            //strip extra characters
            //13 should be leading "classname"
            let className = elementId.slice(13)
            let x_Pos = leftPos.slice(0, leftPos.length - 2)
            let y_Pos = topPos.slice(0, topPos.length - 2)
            fetch("/updateClassPosition", {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                //second words capitalized to distinguish variables
                body: JSON.stringify({
                    classname: className,
                    x_pos: x_Pos,
                    y_pos: y_Pos
                })
            })
                .then(resp => {
                    if (resp.status >= 400) {
                        return resp.json();
                    } else {
                        displayClassDetails(className);
                    }
                })
                .then(data => {
                    console.log(data);
                    if (data && data.error) {
                        snackbar(data.error);
                    }
                })
                .catch(error => console.log(error))
        }
    </script>
</body>

</html>